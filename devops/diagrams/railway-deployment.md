# Railway Deployment Flow

This diagram shows the deployment process for KARS on Railway (production environment).

## Railway Deployment Architecture

```mermaid
flowchart TB
    subgraph GitHub["GitHub Repository"]
        A[Push to main Branch] --> B[GitHub Actions Build]
        B --> C[Tests Pass]
        C --> D[Create Release Tag<br/>v1.x.x]
    end
    
    subgraph Railway["Railway Platform"]
        D --> E[Railway Webhook Triggered]
        E --> F[Clone Repository]
        F --> G[Detect Services]
        
        G --> H[Backend Service]
        G --> I[Frontend Service]
        
        H --> J[Build Backend]
        J --> K[Install Dependencies<br/>npm ci]
        K --> L[Start Command<br/>node server.js]
        
        I --> M[Build Frontend]
        M --> N[npm run build]
        N --> O[nginx Static Server]
    end
    
    subgraph Database["PostgreSQL"]
        P[Railway PostgreSQL Plugin] --> Q[Managed Database]
        Q --> R[Automated Backups]
        Q --> S[Connection Pooling]
        L --> Q
    end
    
    subgraph Deployment["Deployment Process"]
        L --> T[Health Check]
        O --> U[Health Check]
        
        T --> V{Backend<br/>Healthy?}
        U --> W{Frontend<br/>Healthy?}
        
        V -->|No| X[Deployment Failed]
        W -->|No| X
        
        V -->|Yes| Y{All Services<br/>Healthy?}
        W -->|Yes| Y
        
        Y -->|Yes| Z[Switch Traffic<br/>Zero Downtime]
        Y -->|No| X
        
        X --> AA[Keep Previous Version]
        X --> AB[Alert Team]
    end
    
    subgraph Network["Railway Network"]
        Z --> AC[Internal Networking]
        AC --> AD[Backend Service URL<br/>backend.railway.app]
        AC --> AE[Frontend Service URL<br/>frontend.railway.app]
        
        AE --> AF[Custom Domain<br/>kars.jvhlabs.com]
        AF --> AG[Automatic SSL<br/>Let's Encrypt]
    end
    
    subgraph Monitoring["Monitoring"]
        Z --> AH[Railway Metrics]
        AH --> AI[CPU Usage]
        AH --> AJ[Memory Usage]
        AH --> AK[Network Traffic]
        AH --> AL[Deployment History]
        
        AL --> AM[Rollback Available]
    end
    
    style GitHub fill:#e3f2fd
    style Railway fill:#fff3e0
    style Database fill:#f3e5f5
    style Deployment fill:#e8f5e9
    style Network fill:#fce4ec
    style Monitoring fill:#fff9c4
```

## Railway Configuration

### Project Structure

```
kars/
├── backend/
│   ├── server.js           # Entry point
│   ├── package.json        # Dependencies
│   └── Procfile           # Optional: Start command
├── frontend/
│   ├── src/
│   ├── package.json        # Dependencies
│   └── nginx.conf          # Nginx configuration
└── railway.json           # Multi-service configuration
```

### railway.json Configuration

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "numReplicas": 1,
    "startCommand": "node server.js",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

### Backend Service Configuration

**Service Name:** `kars-backend`

**Build Settings:**
- Builder: Nixpacks (auto-detected)
- Build Command: `npm ci --only=production`
- Start Command: `node server.js`
- Node Version: 22 LTS

**Environment Variables:**
```env
NODE_ENV=production
JWT_SECRET=<secure-random-key>
DB_CLIENT=postgres
DATABASE_URL=${DATABASE_URL}  # Auto-injected by Railway
ADMIN_EMAIL=admin@jvhlabs.com
BASE_URL=https://kars.jvhlabs.com
FRONTEND_URL=https://kars.jvhlabs.com
```

**Health Check:**
- Path: `/api/health`
- Port: 3001
- Timeout: 30s

### Frontend Service Configuration

**Service Name:** `kars-frontend`

**Build Settings:**
- Builder: Nixpacks
- Build Command: `npm ci && npm run build`
- Start Command: Auto-detected (nginx)

**Environment Variables:**
```env
NODE_ENV=production
VITE_API_URL=/api  # Proxy to backend
```

**Custom Domain:**
- Domain: `kars.jvhlabs.com`
- SSL: Automatic (Let's Encrypt)

### PostgreSQL Database

**Plugin:** Railway PostgreSQL

**Configuration:**
- Version: PostgreSQL 15
- Storage: 1 GB (scalable)
- Backups: Daily automated
- Connection: Internal networking

**Connection Details:**
```env
DATABASE_URL=postgresql://user:pass@host:5432/railway
POSTGRES_HOST=host.railway.internal
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=<auto-generated>
POSTGRES_DB=railway
```

---

## Deployment Process

### Automatic Deployment (Recommended)

**Trigger:** Push to `main` branch or create release tag

**Flow:**
1. Push code to `main` or tag release
2. Railway detects changes
3. Builds services in parallel
4. Runs health checks
5. Switches traffic (zero downtime)
6. Previous deployment kept for rollback

**Duration:** ~3-5 minutes

**Monitoring:**
```bash
# Via Railway CLI
railway logs

# Via Railway Dashboard
# Project → Deployments → View Logs
```

### Manual Deployment

**Option 1: Railway Dashboard**
1. Navigate to Project
2. Click "Deploy" → "Trigger Deploy"
3. Select branch or commit
4. Click "Deploy"

**Option 2: Railway CLI**
```bash
# Login to Railway
railway login

# Link to project
railway link

# Deploy current directory
railway up

# Deploy specific service
railway up --service backend
```

**Option 3: Redeploy Last Success**
```bash
# In Railway Dashboard
# Deployments → Find last successful → Click "Redeploy"
```

---

## Environment Management

### Setting Environment Variables

**Via Railway Dashboard:**
1. Project → Service → Variables
2. Click "New Variable"
3. Enter name and value
4. Click "Add"
5. Deployment automatically triggered

**Via Railway CLI:**
```bash
# Set variable
railway variables set JWT_SECRET=<value>

# Set multiple variables
railway variables set KEY1=value1 KEY2=value2

# View variables
railway variables

# Delete variable
railway variables delete KEY_NAME
```

### Secret Management

**Best Practices:**
- Never commit secrets to git
- Use Railway variables for all secrets
- Rotate secrets regularly
- Use separate secrets per environment

**Critical Secrets:**
```env
JWT_SECRET=<64-char-random-string>
DATABASE_URL=${DATABASE_URL}  # Auto-injected
ACS_MASTER_KEY=<32-byte-base64>  # For email encryption
SMTP_PASSWORD=<smtp-password>
OIDC_CLIENT_SECRET=<oidc-secret>  # If using SSO
```

---

## Database Operations

### Connection

**From Application:**
```javascript
// Railway auto-injects DATABASE_URL
const connectionString = process.env.DATABASE_URL;
```

**Direct Connection:**
```bash
# Via Railway CLI
railway run psql $DATABASE_URL

# Or with connection string
psql postgresql://user:pass@host:5432/railway
```

### Migrations

**Automatic on Deploy:**

Railway runs migrations automatically if detected:
```json
{
  "scripts": {
    "build": "npm run migrate && npm run build",
    "migrate": "node scripts/migrate.js"
  }
}
```

**Manual Migration:**
```bash
# Via Railway CLI
railway run npm run migrate

# Or SSH into service
railway run bash
npm run migrate
```

### Backups

**Automated Daily Backups:**
- Railway automatically backs up PostgreSQL daily
- Backups retained for 7 days (configurable)
- Accessible via Railway Dashboard

**Manual Backup:**
```bash
# Export database
railway run pg_dump > backup-$(date +%Y%m%d).sql

# Restore database
railway run psql $DATABASE_URL < backup-20241218.sql
```

**Backup Before Major Changes:**
```bash
# Before deployment with schema changes
railway run pg_dump > pre-deploy-backup.sql

# Verify backup
ls -lh pre-deploy-backup.sql
```

---

## Monitoring & Observability

### Railway Metrics

**Available Metrics:**
- CPU Usage (%)
- Memory Usage (MB)
- Network In/Out (MB)
- Request Count
- Response Time (ms)
- Error Rate (%)

**Access Metrics:**
- Railway Dashboard → Project → Metrics
- View by service or aggregate

### Logs

**View Logs:**
```bash
# All services
railway logs

# Specific service
railway logs --service backend

# Follow logs
railway logs --follow

# Filter by time
railway logs --since 1h

# Filter by text
railway logs | grep error
```

**Log Retention:**
- Railway retains logs for 7 days
- Export logs for long-term storage

### Alerts

**Configure Alerts:**
1. Railway Dashboard → Project → Settings
2. Notifications → Add Webhook
3. Configure alert conditions:
   - Deployment failed
   - Service crashed
   - High error rate
   - Resource usage threshold

**Alert Destinations:**
- Slack webhook
- Discord webhook
- Email
- Custom webhook

---

## Scaling

### Horizontal Scaling

**Increase Replicas:**
```bash
# Via Railway CLI
railway scale web=3

# Via Dashboard
# Service → Settings → Scale → Number of Replicas
```

**Load Balancing:**
- Railway automatically load balances across replicas
- Session affinity available if needed

### Vertical Scaling

**Increase Resources:**
1. Railway Dashboard → Service → Settings
2. Resources → Select plan
3. Plans available:
   - Hobby: 512 MB RAM, 0.5 CPU
   - Pro: 8 GB RAM, 8 CPU
   - Custom: Contact Railway

### Auto-Scaling (Pro Plan)

**Configure Auto-Scaling:**
- Min replicas: 1
- Max replicas: 10
- CPU threshold: 70%
- Memory threshold: 80%

---

## Rollback Procedures

### Automatic Rollback

Railway keeps previous deployments for easy rollback:

**Via Dashboard:**
1. Project → Deployments
2. Find last successful deployment
3. Click "..." → "Redeploy"
4. Confirm rollback

**Via CLI:**
```bash
# List deployments
railway status

# Rollback to previous
railway rollback

# Rollback to specific deployment
railway rollback --deployment <deployment-id>
```

### Manual Rollback

**Revert Git Commit:**
```bash
# Revert bad commit
git revert HEAD
git push origin main

# Railway will auto-deploy the revert
```

**Restore Database (if needed):**
```bash
# Stop services
railway scale web=0

# Restore from backup
railway run psql $DATABASE_URL < backup-pre-deploy.sql

# Restart services
railway scale web=1
```

---

## Health Checks

### Backend Health Check

**Endpoint:** `/api/health`

**Configuration in Railway:**
```json
{
  "healthcheck": {
    "path": "/api/health",
    "port": 3001,
    "interval": 30,
    "timeout": 5,
    "retries": 3
  }
}
```

**Response:**
```json
{
  "status": "ok",
  "timestamp": "2024-12-18T15:30:00.000Z",
  "database": "connected"
}
```

### Frontend Health Check

**Endpoint:** `/`

**Railway auto-configures** health check for static sites.

### Database Health Check

```bash
# Check database connectivity
railway run psql $DATABASE_URL -c "SELECT 1;"

# Check database size
railway run psql $DATABASE_URL -c "\
  SELECT pg_size_pretty(pg_database_size(current_database()));"

# Check connection count
railway run psql $DATABASE_URL -c "\
  SELECT count(*) FROM pg_stat_activity;"
```

---

## Troubleshooting

### Issue: Deployment Fails

**Diagnosis:**
```bash
# View deployment logs
railway logs --deployment latest

# Check build logs
railway logs --since 10m | grep -i error
```

**Common Causes:**
- Dependency installation failure
- Build script error
- Missing environment variables
- Start command failure

**Solutions:**
```bash
# Test build locally
npm ci
npm run build
npm start

# Verify environment variables
railway variables

# Check start command
railway run npm start
```

### Issue: Service Crashes After Deploy

**Diagnosis:**
```bash
# Check crash logs
railway logs --service backend | grep -i "error\|crash\|exit"

# Check exit code
railway status
```

**Common Causes:**
- Database connection failure
- Missing JWT_SECRET
- Port binding issue
- Uncaught exception

**Solutions:**
```bash
# Check environment variables
railway variables | grep JWT_SECRET
railway variables | grep DATABASE_URL

# Test database connection
railway run psql $DATABASE_URL -c "SELECT 1;"

# Check recent code changes
git log -n 5 --oneline
```

### Issue: Slow Performance

**Diagnosis:**
```bash
# Check resource usage
railway status

# View metrics in Dashboard
# Project → Metrics → CPU/Memory
```

**Common Causes:**
- Insufficient resources
- Database query inefficiency
- Memory leak
- High traffic

**Solutions:**
```bash
# Scale up resources
railway scale web=2  # Add replica

# Upgrade plan (if needed)
# Dashboard → Settings → Plan

# Optimize database queries
# Check slow queries in PostgreSQL
railway run psql $DATABASE_URL -c "\
  SELECT query, calls, mean_exec_time \
  FROM pg_stat_statements \
  ORDER BY mean_exec_time DESC \
  LIMIT 10;"
```

### Issue: Cannot Connect to Database

**Diagnosis:**
```bash
# Test database connection
railway run psql $DATABASE_URL -c "SELECT version();"

# Check DATABASE_URL variable
railway variables | grep DATABASE_URL

# Check PostgreSQL service status
railway status --service postgres
```

**Common Causes:**
- DATABASE_URL not set
- PostgreSQL service down
- Connection limit reached
- Network issue

**Solutions:**
```bash
# Verify DATABASE_URL exists
railway variables

# Restart PostgreSQL (if needed)
# Dashboard → PostgreSQL → Restart

# Check connection limit
railway run psql $DATABASE_URL -c "\
  SELECT max_connections, count(*) as current \
  FROM pg_settings, pg_stat_activity \
  WHERE name = 'max_connections' \
  GROUP BY max_connections;"
```

---

## Best Practices

### 1. Use Environment-Specific Branches

```
develop → Railway Staging Project
main → Railway Production Project
```

### 2. Always Backup Before Major Changes

```bash
railway run pg_dump > backup-before-migration.sql
```

### 3. Test in Staging First

Deploy to staging project, verify, then deploy to production.

### 4. Monitor After Deployment

Watch metrics for 30 minutes post-deployment:
```bash
railway logs --follow
```

### 5. Set Up Alerts

Configure alerts for critical metrics:
- Deployment failures
- Service crashes
- High error rates

### 6. Regular Security Updates

Keep dependencies updated:
```bash
npm audit
npm update
```

---

## Related Documentation

- [CI/CD Overview](ci-cd-overview.md) - Full pipeline
- [Database Backup & Restore](database-backup-restore.md) - Database operations
- [Monitoring & Health Checks](monitoring-health-checks.md) - Monitoring setup
- [Incident Escalation](incident-escalation.md) - Incident response
- [Release Process](release-process.md) - Release workflow

---

**Last Updated:** December 2024  
**Maintained By:** DevOps Team  
**Railway Project:** [project-id]
